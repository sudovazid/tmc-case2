name: Case 2 Data Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  dbt_working_dir: ./dbt_project
  # 1. FIX: Tell dbt to look for profiles.yml in the current directory
  DBT_PROFILES_DIR: ./

jobs:
  dbt_validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dbt
        run: |
          pip install dbt-bigquery
          dbt --version

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Configure dbt Profiles
        run: |
          # 2. FIX: Create the key file at the location dbt expects (in the workspace)
          # We save the secret to a file named 'dbt-key.json' inside dbt_project/
          echo '${{ secrets.GCP_SA_KEY }}' > ${{ env.dbt_working_dir }}/dbt-key.json

          # Set the Env Var so profiles.yml can read the filename
          echo "GCP_SA_KEY=./dbt-key.json" >> $GITHUB_ENV

          # Set Project ID
          echo "GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID || 'vazid-live' }}" >> $GITHUB_ENV

      - name: Run dbt Debug
        working-directory: ${{ env.dbt_working_dir }}
        run: dbt debug

      - name: Run dbt Models
        working-directory: ${{ env.dbt_working_dir }}
        run: dbt run

      - name: Run dbt Tests (The Quality Gate)
        working-directory: ${{ env.dbt_working_dir }}
        run: dbt test